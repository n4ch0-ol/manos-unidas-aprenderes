<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIVIA - Chat Inteligente</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --bg-overlay: rgba(15, 23, 42, 0.85); /* Capa oscura sobre la imagen de fondo */
            --bg-panel: rgba(30, 41, 59, 0.7);   /* Paneles semitransparentes */
            --accent: #38bdf8; /* Azul SIVIA */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --user-bubble: #2563eb;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;

            /* --- CONFIGURACI√ìN DEL FONDO --- */
            background-image: url('images/manos_unidas_oscuro.png'); /* TU IMAGEN DE FONDO */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #0f172a; /* Color de respaldo */
        }

        /* Capa oscura para mejorar la lectura sobre la imagen de fondo */
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-overlay);
            z-index: -1;
            backdrop-filter: blur(3px); /* Opcional: un ligero desenfoque al fondo */
        }

        /* --- CABECERA --- */
        header {
            height: 70px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            background: rgba(15, 23, 42, 0.6); /* Cabecera semitransparente */
            backdrop-filter: blur(10px);
        }

        .brand-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .brand-logo {
            height: 40px;
            width: 40px;
            object-fit: cover;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .brand-text {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
            background: linear-gradient(90deg, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- √ÅREA DE CHAT (Centro) --- */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-panel) transparent;
        }

        /* Mensajes */
        .message {
            display: flex;
            gap: 15px;
            animation: fadeIn 0.3s ease;
            line-height: 1.6;
        }

        .avatar {
            width: 35px; height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden; /* Para recortar la imagen */
        }
        /* Estilo para el contenedor del logo del bot */
        .avatar.bot { 
            background: transparent; /* Fondo transparente para la imagen */
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .avatar.user { background: var(--user-bubble); color: white; }

        /* Estilo de la imagen dentro del avatar */
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .content {
            flex: 1;
            max-width: 100%;
        }

        .user-name {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .text-bubble {
            font-size: 16px;
            color: #e2e8f0;
            background: var(--bg-panel); /* Fondo semitransparente para el texto */
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        /* Markdown b√°sico */
        .text-bubble strong { color: var(--accent); }
        .text-bubble a { color: var(--accent); text-decoration: none; border-bottom: 1px dotted; }
        .text-bubble img { 
            max-width: 100%;
            border-radius: 12px; 
            margin-top: 10px; 
            border: 1px solid rgba(255,255,255,0.2);
            display: block;
        }

        /* --- ANIMACI√ìN "PENSANDO" (GEMINI STYLE) --- */
        .thinking-wrapper {
            display: none; /* Oculto por defecto */
            align-items: center;
            gap: 12px;
            margin-left: 50px; /* Alineado con el texto del bot */
            margin-bottom: 20px;
            padding: 10px 0;
        }
        .thinking-wrapper.active { display: flex; }

        .spinner {
            width: 18px; height: 18px;
            border: 2px solid transparent;
            border-top-color: var(--accent);
            border-right-color: #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .thinking-text {
            font-size: 14px;
            color: var(--text-muted);
            font-style: italic;
            animation: pulse 1.5s infinite;
        }

        /* --- √ÅREA DE INPUT (Abajo) --- */
        .input-wrapper {
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
        }

        .input-box {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: border-color 0.2s;
        }
        .input-box:focus-within { border-color: var(--accent); }

        /* Clip de archivo */
        #file-upload { display: none; }
        .attach-btn {
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .attach-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .attach-btn.has-file { color: #4ade80; background: rgba(74, 222, 128, 0.1); }

        /* Campo de texto */
        .main-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            padding: 10px 0;
        }

        /* Bot√≥n Enviar */
        .send-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        .send-btn:hover { color: var(--accent); transform: scale(1.1); }
        .send-btn:disabled { opacity: 0.5; cursor: default; }

        /* Footer peque√±o */
        .footer-note {
            text-align: center;
            font-size: 11px;
            color: #94a3b8;
            margin-top: 10px;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 50% { opacity: 0.5; } }

    </style>
</head>
<body>

    <header>
        <div class="brand-area">
            <img src="images/sivia recuadro derecho.png" alt="SIVIA" class="brand-logo" onerror="this.style.display='none'">
            <span class="brand-text">SIVIA Chat</span>
        </div>
    </header>

    <div class="chat-container" id="chat-stream">
        
        <div class="message">
            <div class="avatar bot">
                <img src="images/sivia recuadro derecho.png" alt="SIVIA">
            </div>
            <div class="content">
                <div class="user-name">SIVIA AI</div>
                <div class="text-bubble">
                    ¬°Hola! Soy tu asistente virtual inteligente. üëã<br><br>
                    Puedo:<br>
                    üåç <strong>Buscar en internet</strong> informaci√≥n actualizada.<br>
                    üìä <strong>Consultar la base de datos</strong> interna.<br>
                    üëÅÔ∏è <strong>Analizar im√°genes</strong> que me env√≠es.<br><br>
                    ¬øEn qu√© te ayudo hoy?
                </div>
            </div>
        </div>

    </div>

    <div class="thinking-wrapper" id="thinking-indicator">
        <div class="spinner"></div>
        <div class="thinking-text" id="thinking-status">Analizando...</div>
    </div>

    <div class="input-wrapper">
        <div class="input-box">
            <label for="file-upload" class="attach-btn" id="clip-btn" title="Adjuntar imagen">
                <span class="material-icons-round">attach_file</span>
            </label>
            <input type="file" id="file-upload" accept="image/*">

            <input type="text" class="main-input" id="user-input" placeholder="Escribe un mensaje a SIVIA..." autocomplete="off">

            <button class="send-btn" id="send-btn" onclick="handleSend()">
                <span class="material-icons-round">send</span>
            </button>
        </div>
        <div class="footer-note">SIVIA puede cometer errores. Verifica la informaci√≥n importante.</div>
    </div>

    <script>
        const API_URL = "https://sivia-backend.onrender.com/chat";
        const LOGO_PATH = "images/sivia recuadro derecho.png"; // Ruta del logo

        const STEPS = [
            "üåé Investigando en la web...",
            "üîç Verificando fuentes...",
            "üìÇ Consultando base de datos...",
            "üñºÔ∏è Procesando elementos visuales...",
            "üß† Analizando contexto...",
            "‚ú® Redactando respuesta..."
        ];

        let currentImageBase64 = null;
        let thinkingInterval;

        // --- FUNCIONES VISUALES ---

        function scrollToBottom() {
            const container = document.getElementById('chat-stream');
            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    currentImageBase64 = evt.target.result.split(',')[1];
                    document.getElementById('clip-btn').classList.add('has-file');
                };
                reader.readAsDataURL(file);
            }
        });

        function startThinking() {
            const wrapper = document.getElementById('thinking-indicator');
            const textEl = document.getElementById('thinking-status');
            wrapper.classList.add('active');
            scrollToBottom();
            let i = 0;
            textEl.innerText = STEPS[0];
            thinkingInterval = setInterval(() => {
                i = (i + 1) % STEPS.length;
                textEl.innerText = STEPS[i];
            }, 1200);
        }

        function stopThinking() {
            clearInterval(thinkingInterval);
            document.getElementById('thinking-indicator').classList.remove('active');
        }

        // FUNCI√ìN MODIFICADA PARA USAR EL LOGO EN LUGAR DEL ROBOT
        function addMessage(text, sender, imgData = null) {
            const container = document.getElementById('chat-stream');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            
            const name = sender === 'bot' ? 'SIVIA AI' : 'T√∫';
            const avatarClass = sender === 'bot' ? 'bot' : 'user';

            // L√≥gica del avatar: Logo para bot, Icono para usuario
            let avatarHTML;
            if (sender === 'bot') {
                avatarHTML = `<img src="${LOGO_PATH}" alt="SIVIA">`;
            } else {
                avatarHTML = `<span class="material-icons-round">person</span>`;
            }

            let contentHTML = text;
            if (sender === 'bot') {
                contentHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                  .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            }

            let imgHTML = '';
            if (sender === 'user' && imgData) {
                imgHTML = `<img src="data:image/jpeg;base64,${imgData}">`;
            }

            msgDiv.innerHTML = `
                <div class="avatar ${avatarClass}">${avatarHTML}</div>
                <div class="content">
                    <div class="user-name">${name}</div>
                    <div class="text-bubble">${contentHTML} ${imgHTML}</div>
                </div>
            `;

            container.appendChild(msgDiv);
            scrollToBottom();
        }

        // --- L√ìGICA DE ENV√çO ---
        async function handleSend() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const btn = document.getElementById('send-btn');

            if (!text && !currentImageBase64) return;

            addMessage(text, 'user', currentImageBase64);
            
            input.value = '';
            input.disabled = true;
            btn.style.color = '#475569';
            document.getElementById('clip-btn').classList.remove('has-file');
            document.getElementById('file-upload').value = '';

            startThinking();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: text,
                        image: currentImageBase64
                    })
                });

                const data = await response.json();
                stopThinking();
                addMessage(data.answer, 'bot');

            } catch (error) {
                stopThinking();
                addMessage("‚ö†Ô∏è Error de conexi√≥n. El servidor puede estar 'durmiendo' (espera 30s) o no tienes internet.", 'bot');
            }

            currentImageBase64 = null;
            input.disabled = false;
            btn.style.color = ''; 
            input.focus();
            scrollToBottom();
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });
        document.getElementById('user-input').focus();

    </script>
</body>
</html>
